<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Dodge Game Ultimate</title>

<style>
* { margin:0; padding:0; touch-action:none; user-select:none; }
body { background:#000; overflow:hidden; }
canvas { display:block; background:#111; }

/* Joystick */
#joystick {
  position: fixed;
  bottom: 40px;
  left: 40px;
  width: 120px;
  height: 120px;
  border-radius: 50%;
  background: rgba(255,255,255,0.1);
}
#stick {
  position: absolute;
  top: 40px;
  left: 40px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: rgba(255,255,255,0.8);
}
</style>
</head>
<body>

<canvas id="game"></canvas>
<div id="joystick"><div id="stick"></div></div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");
const joystick = document.getElementById("joystick");
const stick = document.getElementById("stick");

function resize() {
  canvas.width = innerWidth;
  canvas.height = innerHeight;
}
addEventListener("resize", resize);
resize();

// ===== PLAYER =====
const player = {
  x: canvas.width/2-25,
  y: canvas.height-100,
  w: 50,
  h: 50,
  speed: 10,
  shield: false
};

// ===== GAME DATA =====
let obstacles = [];
let items = [];
let score = 0;
let level = 1;
let gameOver = false;
let slowTime = 0;

// ===== JOYSTICK =====
let joyActive = false;
let joyX = 0;

joystick.addEventListener("touchstart", e => joyActive = true);
joystick.addEventListener("touchmove", e => {
  const rect = joystick.getBoundingClientRect();
  const x = e.touches[0].clientX - rect.left - 60;
  joyX = Math.max(-40, Math.min(40, x));
  stick.style.left = joyX + 40 + "px";
});
joystick.addEventListener("touchend", () => {
  joyActive = false;
  joyX = 0;
  stick.style.left = "40px";
});

// ===== SPAWN =====
function spawnObstacle(boss=false) {
  obstacles.push({
    x: Math.random()*(canvas.width-50),
    y: -60,
    w: boss ? 90 : 50,
    h: boss ? 90 : 50,
    hp: boss ? 5 : 1,
    speed: boss ? 2 : 4 + level*0.5
  });
}

function spawnItem() {
  const type = Math.random()<0.5 ? "slow" : "shield";
  items.push({
    type,
    x: Math.random()*(canvas.width-30),
    y: -30,
    w: 30,
    h: 30,
    speed: 3
  });
}

setInterval(() => {
  if (!gameOver) spawnObstacle();
}, 800);

setInterval(() => {
  if (!gameOver && Math.random()<0.3) spawnItem();
}, 5000);

// ===== UPDATE =====
function update() {
  if (gameOver) return;

  level = Math.floor(score/10)+1;

  // Boss
  if (score>0 && score%50===0 && obstacles.filter(o=>o.hp>1).length===0) {
    spawnObstacle(true);
  }

  // Player move
  player.x += joyX * 0.3;
  player.x = Math.max(0, Math.min(canvas.width-player.w, player.x));

  // Slow effect
  if (slowTime>0) slowTime--;

  // Obstacles
  obstacles.forEach(o => o.y += o.speed * (slowTime>0?0.4:1));

  obstacles = obstacles.filter(o => {
    if (o.y > canvas.height) {
      score++;
      return false;
    }
    return true;
  });

  // Items
  items.forEach(i => i.y += i.speed);

  // Collision
  obstacles.forEach(o => {
    if (hit(player,o)) {
      if (player.shield) {
        player.shield=false;
        o.hp=0;
      } else {
        gameOver=true;
      }
    }
  });

  items = items.filter(i => {
    if (hit(player,i)) {
      if (i.type==="slow") slowTime=300;
      if (i.type==="shield") player.shield=true;
      return false;
    }
    return i.y<canvas.height;
  });
}

// ===== DRAW =====
function draw() {
  ctx.clearRect(0,0,canvas.width,canvas.height);

  ctx.fillStyle = player.shield ? "#0ff" : "#0f0";
  ctx.fillRect(player.x,player.y,player.w,player.h);

  obstacles.forEach(o=>{
    ctx.fillStyle = o.hp>1 ? "#f0f" : "#f00";
    ctx.fillRect(o.x,o.y,o.w,o.h);
  });

  items.forEach(i=>{
    ctx.fillStyle = i.type==="slow"?"#00f":"#ff0";
    ctx.fillRect(i.x,i.y,i.w,i.h);
  });

  ctx.fillStyle="#fff";
  ctx.font="20px Arial";
  ctx.fillText(`Score: ${score}`,20,40);
  ctx.fillText(`Level: ${level}`,20,70);
  ctx.fillText(`Shield: ${player.shield?"ON":"OFF"}`,20,100);

  if(gameOver){
    ctx.font="40px Arial";
    ctx.textAlign="center";
    ctx.fillText("GAME OVER",canvas.width/2,canvas.height/2);
    ctx.font="20px Arial";
    ctx.fillText("Chạm để chơi lại",canvas.width/2,canvas.height/2+40);
    ctx.textAlign="left";
  }
}

function hit(a,b){
  return a.x<a.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y;
}

// Restart
canvas.addEventListener("touchstart",()=>gameOver&&location.reload());

// Loop
(function loop(){
  update();
  draw();
  requestAnimationFrame(loop);
})();
</script>

</body>
</html>
